<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>AR Duck Placer</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body { margin: 0; }
    .a-canvas {
      pointer-events: auto !important; 
    }
    #ui-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      justify-content: center;
      align-items: center;
      width: 100%;
      text-align: center;
      pointer-events: none; 
      z-index: 1;
    }
    #startARButton {
      pointer-events: auto; 
      padding: 12px 24px;
      background: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    webxr="optionalFeatures: dom-overlay,dom-overlay-for-handheld-ar; overlayElement: #ui-container;"
    renderer="antialias: true; alpha: true; precision: mediump;"
    cursor="rayOrigin: mouse; fuse: false" 
    raycaster="objects: .clickable">      

    <a-assets>
      <a-asset-item id="duck" src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity id="hit-test-marker" visible="false"> 
      <a-circle radius="0.1" color="#FF0000" rotation="-90 0 0" material="shader: flat; transparent: true; opacity: 0.5"></a-circle>
    </a-entity>
  </a-scene>

  <!-- <div id="ui-container">
    <button id="startARButton">Start AR</button>
  </div> -->

  <script>
    if (!AFRAME.components['ar-hit-test']) {
      AFRAME.registerComponent('ar-hit-test', {
        init: function() {
          this.xrHitTestSource = null;
          this.viewerSpace = null;
          this.refSpace = null;

          this.el.sceneEl.renderer.xr.addEventListener('sessionstart', async () => {
            try { 
              this.viewerSpace = await this.el.sceneEl.renderer.xr.getSession().requestReferenceSpace('viewer');
              this.refSpace = await this.el.sceneEl.renderer.xr.getSession().requestReferenceSpace('local');
              this.xrHitTestSource = await this.el.sceneEl.renderer.xr.getSession().requestHitTestSource({
                space: this.viewerSpace
              });
              console.log('AR session started and hit test source created.');
            } catch (error) {
              console.error('Error starting AR session or creating hit test source:', error);
            }
          });

          this.el.sceneEl.renderer.xr.addEventListener('sessionend', () => {
            this.xrHitTestSource = null;
            console.log('AR session ended.');
          });
        },

        tick: function() { 
          if (this.el.sceneEl.is('ar-mode')) {
            if (!this.xrHitTestSource) return;

            const frame = this.el.sceneEl.frame;
            if (!frame) return; 

            const xrViewerPose = frame.getViewerPose(this.refSpace);
            if (xrViewerPose) {
              const hitTestResults = frame.getHitTestResults(this.xrHitTestSource);
              if (hitTestResults.length > 0) {
                const hit = hitTestResults[0];
                const hitPose = hit.getPose(this.refSpace);
                if (hitPose) { 
                  this.el.setAttribute('position', hitPose.transform.position);
                  this.el.setAttribute('visible', true);
                }
              } else {
                this.el.setAttribute('visible', false); 
              }
            } else {
              this.el.setAttribute('visible', false); 
            }
          } else {
            this.el.setAttribute('visible', false);
          }
        }
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const scene = document.querySelector('a-scene');
      const marker = document.querySelector('#hit-test-marker');
      const startARButton = document.querySelector('#startARButton');
      let placedDucks = [];

      marker.setAttribute('ar-hit-test', ''); 

      function createDuck(position) {
        const duck = document.createElement('a-entity');
        duck.setAttribute('gltf-model', '#duck');
        duck.setAttribute('position', position);
        duck.setAttribute('scale', '0.2 0.2 0.2');
        duck.setAttribute('class', 'clickable');
        duck.setAttribute('rotation', '0 ' + (Math.random() * 360) + ' 0'); 
        scene.appendChild(duck);
        placedDucks.push(duck);
        console.log('Duck placed at:', position); 
      }

      ['click', 'touchend'].forEach(eventName => {
        scene.addEventListener(eventName, (event) => {
          if (scene.is('ar-mode')) {
            event.preventDefault();
            const position = marker.getAttribute('position');
            if (marker.getAttribute('visible') && position) { 
              createDuck(position);
            } else {
              console.warn('Cannot place duck: No surface detected at tap location.'); 
            }
          }
        });
      });

      if (!navigator.xr) {
        startARButton.textContent = 'WebXR Not Available';
        startARButton.disabled = true;
        console.warn('WebXR not available on this browser/device.');
        return;
      }

      startARButton.addEventListener('click', async () => {
        try {
          const supported = await navigator.xr.isSessionSupported('immersive-ar');
          if (!supported) {
            throw new Error('AR not supported on this device');
          }

          await scene.enterAR();
          startARButton.style.display = 'none'; 
          marker.setAttribute('visible', true); 
          console.log('Entering AR mode.');
        } catch (error) {
          console.error('Error entering AR:', error);
          startARButton.textContent = error.message; 
        }
      });
    });
  </script>
</body>
</html>